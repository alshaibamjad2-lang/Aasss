<script>
// ----------------------
// Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
// ----------------------
const SUPABASE_URL = "https://ztwbgqkxmdhpzqhnefty.supabase.co";
const SUPABASE_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0d2JncWt4bWRocHpxaG5lZnR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTQwMDEsImV4cCI6MjA3OTU5MDAwMX0.6W_V9v5VxQpPfv65Ygc51-m7G1Z8sl8fx1B8bWyA6Xg";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ----------------------
// ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
// ----------------------
let categories = [];
let products = [];

let currentSection = null;
let viewIndex = 0;
let cart = [];

const views = [
  { cls:'mode-grid', label:'Grid 2Ã—2' },
  { cls:'mode-grid3', label:'Grid 3Ã—3' },
  { cls:'mode-row', label:'ØµÙ ÙƒØ§Ù…Ù„' },
  { cls:'mode-slider', label:'Slider Ø£ÙÙ‚ÙŠ' },
  { cls:'mode-circle', label:'Circle Cards' },
  { cls:'mode-mag', label:'Magazine' },
  { cls:'mode-luxury', label:'Luxury Cards' },
  { cls:'mode-crystal', label:'Crystal Cards' }
];

// ----------------------
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase
// ----------------------
async function loadData() {

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
  const { data: cats, error: catErr } = await client
    .from("categories")
    .select("*")
    .order("id");

  if (catErr) {
    console.error("Error loading categories:", catErr);
    return;
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  const { data: prods, error: prodErr } = await client
    .from("products")
    .select("*")
    .order("id");

  if (prodErr) {
    console.error("Error loading products:", prodErr);
    return;
  }

  categories = cats;
  products = prods;

  renderSections();
  currentSection = categories.length ? categories[0].id : null;
  renderMeals();
}

// ----------------------
// Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
// ----------------------
function renderSections() {
  const sec = document.getElementById("sections");
  sec.innerHTML = "";

  categories.forEach(cat => {
    sec.innerHTML += `
      <button class="section-btn ${!currentSection || currentSection === cat.id ? 'active':''}"
        data-section="${cat.id}">
        ${cat.name}
      </button>
    `;
  });

  document.querySelectorAll('.section-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelector('.section-btn.active')?.classList.remove('active');
      btn.classList.add('active');
      currentSection = btn.dataset.section;
      renderMeals();
    });
  });
}

// ----------------------
// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
// ----------------------
function renderMeals(){
  const mealsDiv = document.getElementById('meals');
  mealsDiv.innerHTML = "";

  // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
  const list = products.filter(p => p.category_id == currentSection);

  list.forEach((m,i)=>{
    const card = document.createElement('div');
    card.className = 'meal';

    // magazine style (Ù†ÙØ³ Ù†Ø¸Ø§Ù…Ùƒ)
    if(views[viewIndex].cls==='mode-mag' && i % 4 === 0) {
      card.classList.add('big');
    }

    // ØªØ¬Ù‡ÙŠØ² Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Supabase
    let imgURL = "";
    if (m.image_url) {
      imgURL = `${SUPABASE_URL}/storage/v1/object/public/menu-images/${m.image_url}`;
    }

    card.innerHTML = `
      <div class="img"><img src="${imgURL}"></div>
      <div class="info">
        <h3>${m.name}</h3>
        <p>${m.desc || ""}</p>
        <div class="price">${m.price} Ø±.Ø³</div>
        <button class="add-to-cart" data-name="${m.name}" data-price="${m.price}">
          Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
        </button>
      </div>
    `;
    mealsDiv.appendChild(card);
  });

  applyViewClass();
}

// ----------------------
// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
// ----------------------
function applyViewClass(){
  const mealsDiv = document.getElementById('meals');
  const viewNameEl = document.getElementById('viewName');

  mealsDiv.className = 'meals ' + views[viewIndex].cls;
  viewNameEl.textContent = views[viewIndex].label;
}

// ----------------------
// Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶
// ----------------------
document.getElementById('toggleView').addEventListener('click', ()=>{
  viewIndex = (viewIndex + 1) % views.length;
  renderMeals();
});

// ----------------------
// Ø¨Ù‚ÙŠØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù„Ø© â€” ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ø­Ø±ÙÙŠÙ‹Ø§
// ----------------------
/* FLY ANIMATION */
function flyToCart(imgEl, done){
  const cartBtn = document.getElementById('openCart');
  const a = imgEl.getBoundingClientRect();
  const b = cartBtn.getBoundingClientRect();

  const clone = imgEl.cloneNode(true);
  clone.className = "flying-clone";
  clone.style.left = a.left+"px";
  clone.style.top = a.top+"px";
  clone.style.width = a.width+"px";
  clone.style.height = a.height+"px";
  document.body.appendChild(clone);

  const tx = b.left + b.width/2 - (a.left + a.width/2);
  const ty = b.top + b.height/2 - (a.top + a.height/2);

  requestAnimationFrame(()=>{
    clone.style.transform = `translate(${tx}px,${ty}px) scale(.2)`;
    clone.style.opacity = ".5";
  });

  clone.addEventListener('transitionend', ()=>{
    clone.remove();
    done();
  }, {once:true});
}

/* ADD / REMOVE / QTY */
document.addEventListener('click', (e)=>{

  /* ADD TO CART */
  if(e.target.classList.contains('add-to-cart')){
    const name = e.target.dataset.name;
    const price = Number(e.target.dataset.price);
    const card = e.target.closest('.meal');
    const imgEl = card.querySelector('.img img');

    const found = cart.find(it=>it.name===name);
    if(found){
      found.qty++;
      updateCartUI();
      return;
    }

    flyToCart(imgEl, ()=>{
      cart.push({name, price, qty:1});
      updateCartUI();
    });
  }

  /* QTY BUTTONS */
  if(e.target.classList.contains('qty-btn')){
    const idx = Number(e.target.dataset.index);
    const op = e.target.dataset.op;

    if(op==="plus") cart[idx].qty++;
    if(op==="minus"){
      cart[idx].qty--;
      if(cart[idx].qty <= 0){
        cart.splice(idx,1);
      }
    }
    updateCartUI();
  }

  if(e.target.classList.contains('remove')){
    const idx = Number(e.target.dataset.index);
    cart.splice(idx,1);
    updateCartUI();
  }
});

/* CART UI UPDATE */
function updateCartUI(){
  const itemsDiv = document.getElementById('cartItems');
  const countEl = document.getElementById('cartCount');
  const totalEl = document.getElementById('cartTotal');

  itemsDiv.innerHTML='';
  countEl.textContent = cart.length;

  let total = 0;

  cart.forEach((item,idx)=>{
    total += item.price * item.qty;

    const row = document.createElement('div');
    row.className = 'cart-item';
    row.innerHTML = `
      <div>
        <strong>${item.name}</strong><br>
        <span>${item.price} Ø±.Ø³ Ã— ${item.qty}</span>
      </div>

      <div style="display:flex; flex-direction:column; gap:6px;">
        <div style="display:flex; gap:6px;">
          <button class="qty-btn" data-op="plus" data-index="${idx}">+</button>
          <button class="qty-btn" data-op="minus" data-index="${idx}">âˆ’</button>
        </div>
        <div class="remove" data-index="${idx}" style="color:var(--gold); cursor:pointer;">Ø­Ø°Ù</div>
      </div>
    `;
    itemsDiv.appendChild(row);
  });

  totalEl.textContent = total.toFixed(2)+" Ø±.Ø³";
}

/* CART open/close */
document.getElementById('openCart').addEventListener('click', ()=>{
  document.getElementById('cartSidebar').classList.add('open');
  document.getElementById('cartOverlay').classList.add('show');
});
document.getElementById('cartOverlay').addEventListener('click', ()=>{
  document.getElementById('cartSidebar').classList.remove('open');
  document.getElementById('cartOverlay').classList.remove('show');
});

/* CLEAR CART */
document.getElementById('clearCart').addEventListener('click', ()=>{
  cart=[];
  updateCartUI();
});

/* TABLE order option */
document.getElementById('checkout').addEventListener('click', ()=>{
  if(cart.length===0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!");

  const orderType = document.querySelector('input[name="orderType"]:checked').value;

  if(orderType === "table"){
    const tableNum = document.getElementById('tableNumber').value.trim();
    if(tableNum === ""){
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©");
      return;
    }
    alert("ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø·Ù„Ø¨ Ø·Ø§ÙˆÙ„Ø© Ø±Ù‚Ù… " + tableNum + " Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰");
  } else {
    alert("ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø·Ù„Ø¨ Ø³ÙØ±ÙŠ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰");
  }

  cart=[];
  updateCartUI();
});

/* SHOW/HIDE table number */
document.querySelectorAll('input[name="orderType"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    const isTable = document.querySelector('input[name="orderType"]:checked').value === "table";
    document.getElementById('tableNumberWrap').style.display = isTable ? "block" : "none";
  });
});

// ----------------------
// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
// ----------------------
loadData();
updateCartUI();

</script>